<pre>
<code id="htmlViewer" style="color:rgb(197, 200, 198); font-weight:400;background-color:rgb(29, 31, 33);background:rgb(29, 31, 33);display:block;padding: .5em;"><span style="color:rgb(178, 148, 187); font-weight:400;">const</span> mongoose = <span style="color:rgb(222, 147, 95); font-weight:400;">require</span>(<span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;mongoose&#x27;</span>)

<span style="color:rgb(178, 148, 187); font-weight:400;">const</span> bookSchema = mongoose.<span class="hljs-title class_">Schema</span>({
    <span style="color:rgb(197, 200, 198); font-weight:400;">userId</span>: { <span style="color:rgb(178, 148, 187); font-weight:400;">type</span> : <span class="hljs-title class_">String</span>, required : [<span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;UserId is missing&#x27;</span>], <span style="color:rgb(197, 200, 198); font-weight:400;">validate</span>: [<span style="color:rgb(204, 102, 102); font-weight:400;">/^[a-z0-9]{5,40}$/</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Invalid user id&#x27;</span>]},
    <span style="color:rgb(197, 200, 198); font-weight:400;">title</span>: { <span style="color:rgb(178, 148, 187); font-weight:400;">type</span> : <span class="hljs-title class_">String</span>, trim : <span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, required : [<span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Title is missing&#x27;</span>], <span style="color:rgb(197, 200, 198); font-weight:400;">validate</span>: [<span style="color:rgb(204, 102, 102); font-weight:400;">/^[a-zéèêëâàäûüùôçA-Z0-9 ,.&#x27;-]{2,24}$/</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Invalid title&#x27;</span>]},
    <span style="color:rgb(197, 200, 198); font-weight:400;">author</span>: { <span style="color:rgb(178, 148, 187); font-weight:400;">type</span> : <span class="hljs-title class_">String</span>, trim : <span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, required : [<span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Author is missing&#x27;</span>], <span style="color:rgb(197, 200, 198); font-weight:400;">validate</span>: [<span style="color:rgb(204, 102, 102); font-weight:400;">/^[a-zéèêëâàäûüùôçA-Z0-9 ,.&#x27;-]{4,24}$/</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Invalid author&#x27;</span>]},
    <span style="color:rgb(197, 200, 198); font-weight:400;">imageUrl</span>: { <span style="color:rgb(178, 148, 187); font-weight:400;">type</span> : <span class="hljs-title class_">String</span>, required : <span style="color:rgb(222, 147, 95); font-weight:400;">true</span>},
    <span style="color:rgb(197, 200, 198); font-weight:400;">year</span>: { <span style="color:rgb(178, 148, 187); font-weight:400;">type</span> : <span class="hljs-title class_">Number</span>, trim : <span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, required : [<span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Year of publication is missing&#x27;</span>], <span style="color:rgb(197, 200, 198); font-weight:400;">validate</span>: [<span style="color:rgb(204, 102, 102); font-weight:400;">/^[0-9]{3,4}$/</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Invalid year&#x27;</span>]},
    <span style="color:rgb(197, 200, 198); font-weight:400;">genre</span>: { <span style="color:rgb(178, 148, 187); font-weight:400;">type</span> : <span class="hljs-title class_">String</span>, trim : <span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, required : [<span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Genre is missing&#x27;</span>], <span style="color:rgb(197, 200, 198); font-weight:400;">validate</span>: [<span style="color:rgb(204, 102, 102); font-weight:400;">/^[a-zéèêëâàäûüùôçA-Z0-9 ,.&#x27;-]{4,24}$/</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Invalid genre&#x27;</span>]},
    <span style="color:rgb(197, 200, 198); font-weight:400;">ratings</span>:    [{
                    _id : <span style="color:rgb(222, 147, 95); font-weight:400;">false</span>,
                    <span style="color:rgb(197, 200, 198); font-weight:400;">userId</span>: {<span style="color:rgb(178, 148, 187); font-weight:400;">type</span> : <span class="hljs-title class_">String</span>, required : [<span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;UserId is missing&#x27;</span>], <span style="color:rgb(197, 200, 198); font-weight:400;">validate</span>: [<span style="color:rgb(204, 102, 102); font-weight:400;">/^[a-z0-9]{5,40}$/</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Invalid user id&#x27;</span>]},
                    <span style="color:rgb(197, 200, 198); font-weight:400;">grade</span>: {<span style="color:rgb(178, 148, 187); font-weight:400;">type</span> : <span class="hljs-title class_">Number</span>, required : <span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, <span style="color:rgb(197, 200, 198); font-weight:400;">min</span>: [<span style="color:rgb(222, 147, 95); font-weight:400;">0</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Invalid number&#x27;</span>], <span style="color:rgb(197, 200, 198); font-weight:400;">max</span>: [<span style="color:rgb(222, 147, 95); font-weight:400;">5</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Invalid number&#x27;</span>]}
                }],
    <span style="color:rgb(197, 200, 198); font-weight:400;">averageRating</span>: { <span style="color:rgb(178, 148, 187); font-weight:400;">type</span> : <span class="hljs-title class_">Number</span>, required : [<span style="color:rgb(222, 147, 95); font-weight:400;">true</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Average rating is missing&#x27;</span>], <span style="color:rgb(197, 200, 198); font-weight:400;">min</span>: [<span style="color:rgb(222, 147, 95); font-weight:400;">0</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Invalid number&#x27;</span>], <span style="color:rgb(197, 200, 198); font-weight:400;">max</span>: [<span style="color:rgb(222, 147, 95); font-weight:400;">5</span>, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Invalid number&#x27;</span>] }
})

<span style="color:rgb(150, 152, 150); font-weight:400;">// virtuals activation : _id &gt; id duplication</span>
bookSchema.<span class="hljs-title function_">set</span>(<span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;toJSON&#x27;</span>, {
    <span style="color:rgb(197, 200, 198); font-weight:400;">virtuals</span>: <span style="color:rgb(222, 147, 95); font-weight:400;">true</span>
})

bookSchema.<span class="hljs-title function_">pre</span>(<span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;updateOne&#x27;</span>, <span style="color:rgb(178, 148, 187); font-weight:400;">function</span>(<span style="color:rgb(222, 147, 95); font-weight:400;">next</span>) {
    <span class="hljs-variable language_">this</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">options</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">runValidators</span> = <span style="color:rgb(222, 147, 95); font-weight:400;">true</span>;
    <span class="hljs-title function_">next</span>();
  });

<span class="hljs-variable language_">module</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">exports</span> = mongoose.<span class="hljs-title function_">model</span>(<span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Book&#x27;</span>, bookSchema)</code></pre>