<pre>
<code id="htmlViewer" style="color:rgb(197, 200, 198); font-weight:400;background-color:rgb(29, 31, 33);background:rgb(29, 31, 33);display:block;padding: .5em;"><span style="color:rgb(178, 148, 187); font-weight:400;">const</span> <span class="hljs-title class_">User</span> = <span style="color:rgb(222, 147, 95); font-weight:400;">require</span>(<span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;../models/User&#x27;</span>)
<span style="color:rgb(178, 148, 187); font-weight:400;">const</span> bcrypt = <span style="color:rgb(222, 147, 95); font-weight:400;">require</span>(<span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;bcrypt&#x27;</span>)
<span style="color:rgb(178, 148, 187); font-weight:400;">const</span> jwt = <span style="color:rgb(222, 147, 95); font-weight:400;">require</span>(<span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;jsonwebtoken&#x27;</span>);


<span style="color:rgb(150, 152, 150); font-weight:400;">// REGISTER USER</span>
<span style="color:rgb(222, 147, 95); font-weight:400;">exports</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">signup</span> = <span style="color:rgb(197, 200, 198); font-weight:400;">(<span style="color:rgb(222, 147, 95); font-weight:400;">req, res, next</span>) =&gt;</span> {
    <span style="color:rgb(150, 152, 150); font-weight:400;">// return an error if the password doesn&#x27;t match 8 &lt;= length &lt;= 24</span>
    <span style="color:rgb(150, 152, 150); font-weight:400;">// can&#x27;t deal with that validation through the model, cause it has to deal with the hash</span>
    <span style="color:rgb(178, 148, 187); font-weight:400;">if</span> (req.<span style="color:rgb(197, 200, 198); font-weight:400;">body</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">password</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">length</span> &lt; <span style="color:rgb(222, 147, 95); font-weight:400;">8</span> || req.<span style="color:rgb(197, 200, 198); font-weight:400;">body</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">password</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">length</span> &gt; <span style="color:rgb(222, 147, 95); font-weight:400;">24</span>) <span style="color:rgb(178, 148, 187); font-weight:400;">return</span> res.<span class="hljs-title function_">status</span>(<span style="color:rgb(222, 147, 95); font-weight:400;">400</span>).<span class="hljs-title function_">json</span>({ message : <span style="color:rgb(181, 189, 104); font-weight:400;">&quot;Password should have at least 8 characters and no more than 24.&quot;</span>})
    bcrypt.<span class="hljs-title function_">hash</span>(req.<span style="color:rgb(197, 200, 198); font-weight:400;">body</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">password</span>, <span style="color:rgb(222, 147, 95); font-weight:400;">10</span>) <span style="color:rgb(150, 152, 150); font-weight:400;">// 10 : number of hashing passes</span>
    .<span class="hljs-title function_">then</span>(<span style="color:rgb(197, 200, 198); font-weight:400;"><span style="color:rgb(222, 147, 95); font-weight:400;">hash</span> =&gt;</span> {
        <span style="color:rgb(178, 148, 187); font-weight:400;">const</span> user = <span style="color:rgb(178, 148, 187); font-weight:400;">new</span> <span class="hljs-title class_">User</span>({
            email : req.<span style="color:rgb(197, 200, 198); font-weight:400;">body</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">email</span>,
            password : hash
        })
        user.<span class="hljs-title function_">save</span>().
        <span class="hljs-title function_">then</span>(<span style="color:rgb(197, 200, 198); font-weight:400;">() =&gt;</span> res.<span class="hljs-title function_">status</span>(<span style="color:rgb(222, 147, 95); font-weight:400;">201</span>).<span class="hljs-title function_">json</span>({ message : <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;User created.&#x27;</span>}))
        .<span class="hljs-title function_">catch</span>(<span style="color:rgb(197, 200, 198); font-weight:400;"><span style="color:rgb(222, 147, 95); font-weight:400;">error</span> =&gt;</span> res.<span class="hljs-title function_">status</span>(<span style="color:rgb(222, 147, 95); font-weight:400;">400</span>).<span class="hljs-title function_">json</span>({ message : <span style="color:rgb(181, 189, 104); font-weight:400;">&quot;User can&#x27;t be created.&quot;</span>, error : error }))
    }).<span class="hljs-title function_">catch</span>(<span style="color:rgb(197, 200, 198); font-weight:400;"><span style="color:rgb(222, 147, 95); font-weight:400;">error</span> =&gt;</span> res.<span class="hljs-title function_">status</span>(<span style="color:rgb(222, 147, 95); font-weight:400;">500</span>).<span class="hljs-title function_">json</span>({ message : <span style="color:rgb(181, 189, 104); font-weight:400;">&quot;User can&#x27;t be created.&quot;</span>, error : error }))
}

<span style="color:rgb(150, 152, 150); font-weight:400;">// LOG USER</span>
<span style="color:rgb(222, 147, 95); font-weight:400;">exports</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">login</span> = <span style="color:rgb(197, 200, 198); font-weight:400;">(<span style="color:rgb(222, 147, 95); font-weight:400;">req, res, next</span>) =&gt;</span> {
    <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOne</span>({ <span style="color:rgb(197, 200, 198); font-weight:400;">email</span>: req.<span style="color:rgb(197, 200, 198); font-weight:400;">body</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">email</span> })
    .<span class="hljs-title function_">then</span>(<span style="color:rgb(197, 200, 198); font-weight:400;"><span style="color:rgb(222, 147, 95); font-weight:400;">user</span> =&gt;</span> 
        {
        <span style="color:rgb(178, 148, 187); font-weight:400;">if</span> (!user) <span style="color:rgb(178, 148, 187); font-weight:400;">return</span> res.<span class="hljs-title function_">status</span>(<span style="color:rgb(222, 147, 95); font-weight:400;">401</span>).<span class="hljs-title function_">json</span>({ message : <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Password &amp; login dont match.&#x27;</span>})
        
        <span style="color:rgb(150, 152, 150); font-weight:400;">// compare the processed sent password with the hashed one in db</span>
        bcrypt.<span class="hljs-title function_">compare</span>(req.<span style="color:rgb(197, 200, 198); font-weight:400;">body</span>.<span style="color:rgb(197, 200, 198); font-weight:400;">password</span>, user.<span style="color:rgb(197, 200, 198); font-weight:400;">password</span>)
        .<span class="hljs-title function_">then</span>(<span style="color:rgb(197, 200, 198); font-weight:400;"><span style="color:rgb(222, 147, 95); font-weight:400;">valid</span> =&gt;</span> 
            {
            <span style="color:rgb(178, 148, 187); font-weight:400;">if</span> (!valid) { <span style="color:rgb(178, 148, 187); font-weight:400;">return</span> res.<span class="hljs-title function_">status</span>(<span style="color:rgb(222, 147, 95); font-weight:400;">401</span>).<span class="hljs-title function_">json</span>({ message : <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;Password &amp; login dont match.&#x27;</span> });}

            res.<span class="hljs-title function_">status</span>(<span style="color:rgb(222, 147, 95); font-weight:400;">200</span>).<span class="hljs-title function_">json</span>({
                <span style="color:rgb(197, 200, 198); font-weight:400;">userId</span>: user.<span style="color:rgb(197, 200, 198); font-weight:400;">_id</span>,
                <span style="color:rgb(150, 152, 150); font-weight:400;">// send back a jsonwebtoken</span>
                <span style="color:rgb(197, 200, 198); font-weight:400;">token</span>: jwt.<span class="hljs-title function_">sign</span>({ <span style="color:rgb(197, 200, 198); font-weight:400;">userId</span>: user.<span style="color:rgb(197, 200, 198); font-weight:400;">_id</span> }, <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;RANDOM_TOKEN_SECRET&#x27;</span>, { <span style="color:rgb(197, 200, 198); font-weight:400;">expiresIn</span>: <span style="color:rgb(181, 189, 104); font-weight:400;">&#x27;1h&#x27;</span> })
            })
            }).<span class="hljs-title function_">catch</span>(<span style="color:rgb(197, 200, 198); font-weight:400;"><span style="color:rgb(222, 147, 95); font-weight:400;">error</span> =&gt;</span> res.<span class="hljs-title function_">status</span>(<span style="color:rgb(222, 147, 95); font-weight:400;">500</span>).<span class="hljs-title function_">json</span>({ message : <span style="color:rgb(181, 189, 104); font-weight:400;">&quot;Encryption error.&quot;</span>, error : error }))
        }).<span class="hljs-title function_">catch</span>(<span style="color:rgb(197, 200, 198); font-weight:400;"><span style="color:rgb(222, 147, 95); font-weight:400;">error</span> =&gt;</span> res.<span class="hljs-title function_">status</span>(<span style="color:rgb(222, 147, 95); font-weight:400;">404</span>).<span class="hljs-title function_">json</span>({ message : <span style="color:rgb(181, 189, 104); font-weight:400;">&quot;Unknown user.&quot;</span>, error : error }))
}</code></pre>